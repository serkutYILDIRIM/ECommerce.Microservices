# Microservices Observability with OpenTelemetry

A demonstration project showing a complete implementation of OpenTelemetry across a .NET microservices ecosystem. This project implements distributed tracing, metrics, and logging with backend visualization and analysis.

## Architecture Overview

This project consists of three microservices that work together to simulate an e-commerce system:

- **ProductCatalogService**: Manages product information and inventory
- **OrderProcessingService**: Handles order creation and processing
- **InventoryManagementService**: Manages product stock levels and reservations

The observability stack includes:

- **OpenTelemetry Collector**: Collects, processes, and exports telemetry data
- **Prometheus**: Stores time-series metrics data
- **Tempo**: Stores distributed tracing data
- **Loki**: Stores log data
- **Grafana**: Unified visualization and dashboarding

```mermaid
graph TD
    subgraph "Microservices"
        Product["ProductCatalogService"]
        Order["OrderProcessingService"]
        Inventory["InventoryManagementService"]
    end

    subgraph "OpenTelemetry"
        Collector["OpenTelemetry Collector"]
    end

    subgraph "Observability Backend"
        Prometheus["Prometheus\\n(Metrics)"]
        Tempo["Tempo\\n(Traces)"]
        Loki["Loki\\n(Logs)"]
    end

    subgraph "Visualization"
        Grafana["Grafana Dashboards"]
    end

    %% Connections between services
    Product <--> Order
    Order <--> Inventory
    Product <--> Inventory

    %% Telemetry flow
    Product --> Collector
    Order --> Collector
    Inventory --> Collector

    %% Backend connections
    Collector --> Prometheus
    Collector --> Tempo
    Collector --> Loki

    %% Visualization
    Prometheus --> Grafana
    Tempo --> Grafana
    Loki --> Grafana

    style Product fill:#90caf9,stroke:#1565c0
    style Order fill:#90caf9,stroke:#1565c0
    style Inventory fill:#90caf9,stroke:#1565c0
    style Collector fill:#ffcc80,stroke:#ef6c00
    style Prometheus fill:#a5d6a7,stroke:#2e7d32
    style Tempo fill:#a5d6a7,stroke:#2e7d32
    style Loki fill:#a5d6a7,stroke:#2e7d32
    style Grafana fill:#ce93d8,stroke:#7b1fa2
```

![Architecture Diagram](./docs/images/architecture-diagram.png)

## Features

- **Distributed Tracing**: End-to-end transaction visibility across services
- **Metrics Collection**: Business and technical KPIs with real-time dashboards
- **Structured Logging**: Context-aware logs linked to traces
- **Health Monitoring**: Service health indicators and alerts
- **Performance Analysis**: Latency analysis, bottleneck detection
- **Error Tracking**: Automatic error capture and correlation
- **Custom Instrumentation**: Business-specific metrics and traces

## Prerequisites

- [.NET 7 SDK](https://dotnet.microsoft.com/download) or newer
- [Docker](https://www.docker.com/products/docker-desktop)
- [Docker Compose](https://docs.docker.com/compose/install/)
- [PowerShell](https://docs.microsoft.com/en-us/powershell/) (for running demo scripts)

## Quick Start

### 1. Clone the Repository

```bash
git clone [repository-url]
cd opentelemetryProjectExample
```

### 2. Start the Infrastructure Services

```bash
docker-compose up -d
```

This starts Prometheus, Grafana, OpenTelemetry Collector, and the database.

### 3. Build and Run the Microservices

```bash
# Build all services
dotnet build

# Run services (in separate terminals)
cd src/ProductCatalogService
dotnet run

cd src/OrderProcessingService
dotnet run

cd src/InventoryManagementService
dotnet run
```

Alternatively, run all services with Docker Compose:

```bash
docker-compose -f docker-compose.yml -f docker-compose.services.yml up -d
```

### 4. Access the Services

- **ProductCatalogService**: http://localhost:5001/swagger
- **OrderProcessingService**: http://localhost:5002/swagger
- **InventoryManagementService**: http://localhost:5003/swagger
- **Grafana**: http://localhost:3000 (default credentials: admin/admin)
- **Prometheus**: http://localhost:9090
- **OpenTelemetry Collector**: http://localhost:4317 (gRPC), http://localhost:4318 (HTTP)

## Running the Demo Scenario

We've provided a comprehensive demonstration scenario to showcase the observability features:

```powershell
# Run the automated demo script (starts infrastructure, services, and generates traffic)
.\scripts\Run-DemoScenario.ps1 -Duration 10 -Intensity Medium

# If you want to just generate traffic to already running services
.\scripts\Generate-SampleTraffic.ps1 -Duration 5 -Intensity Medium
```

### Demo Documentation

After running the demo, explore these resources:

1. **[Observability Guided Tour](./docs/ObservabilityGuidedTour.md)**: Step-by-step instructions for exploring the observability features
2. **[Expected Telemetry Patterns](./docs/ExpectedTelemetryPatterns.md)**: Explanation of the telemetry data patterns generated by the demo
3. **[OpenTelemetry Concepts](./docs/OpenTelemetryConcepts.md)**: Details on the OpenTelemetry implementation
4. **[Performance Tuning](./docs/PerformanceTuning.md)**: Guidance on optimizing the observability implementation

## Advanced Configuration

### Environment Variables

Each service supports the following environment variables for customization:

| Variable | Description | Default |
|----------|-------------|---------|
| `ASPNETCORE_ENVIRONMENT` | Runtime environment | `Development` |
| `ConnectionStrings__DefaultConnection` | Database connection string | In-memory DB |
| `OTEL_EXPORTER_OTLP_ENDPOINT` | OpenTelemetry collector endpoint | `http://localhost:4317` |
| `OTEL_SERVICE_NAME` | Service name for telemetry | Service-specific |
| `OTEL_RESOURCE_ATTRIBUTES` | Additional resource attributes | Varies |

### Custom Sampling

The application implements custom sampling strategies:

- **Error-based sampling**: Always samples failed transactions
- **Latency-based sampling**: Increases sampling rate for slow transactions
- **Business-value sampling**: Higher sampling rates for critical business operations

Configure sampling rates in `appsettings.json`:

```json
{
  "OpenTelemetry": {
    "Sampling": {
      "BaseRate": 0.1,
      "ErrorSamplingRate": 1.0,
      "LatencyThresholdMs": 500,
      "HighValueSamplingRate": 0.5
    }
  }
}
```

## Available Dashboards

The project includes pre-configured Grafana dashboards:

1. **Service Health Dashboard**: Overall health and SLIs for each service
2. **Business KPI Dashboard**: Business-focused metrics and KPIs
3. **Performance Analysis Dashboard**: Detailed performance metrics for troubleshooting
4. **Trace Sampling Dashboard**: Analysis of trace sampling effectiveness
5. **Error Tracking Dashboard**: Error rates, types, and patterns
6. **Composite Metrics Dashboard**: Combined views of business and technical metrics

## Development Guide

### Project Structure

```
└── opentelemetryProjectExample/
    ├── src/
    │   ├── ProductCatalogService/    # Product catalog microservice
    │   ├── OrderProcessingService/   # Order processing microservice
    │   ├── InventoryManagementService/ # Inventory management microservice
    │   └── Shared.Library/           # Shared code and utilities
    ├── scripts/
    │   ├── Generate-SampleTraffic.ps1  # Traffic generation script
    │   └── Run-DemoScenario.ps1        # Complete demo automation
    ├── docs/
    │   ├── ObservabilityGuidedTour.md  # Step-by-step feature tour
    │   ├── ExpectedTelemetryPatterns.md # Expected telemetry patterns
    │   ├── OpenTelemetryConcepts.md    # OpenTelemetry documentation
    │   └── PerformanceTuning.md        # Performance optimization guide
    ├── grafana/                      # Grafana configuration and dashboards
    │   ├── dashboards/               # Pre-configured dashboards
    │   └── provisioning/             # Datasource and dashboard provisioning
    ├── docker-compose.yml            # Docker composition for infrastructure
    ├── docker-compose.services.yml   # Docker composition for services
    ├── otel-collector-config.yaml    # OpenTelemetry Collector configuration
    └── prometheus.yml                # Prometheus configuration
```

### Adding New Instrumentation

1. **Custom Metrics**: Use the pattern in `*Metrics.cs` files
2. **Custom Traces**: See examples in `TracingExtensions.cs`
3. **Custom Logs**: Follow the patterns in `LoggingExtensions.cs`

### Testing Observability

The project includes test controllers to verify observability components:

- `TracingTestController`: Test distributed tracing
- `ExceptionHandlingTestController`: Test error tracking
- `TelemetryTestController`: General telemetry verification

## Troubleshooting

### Common Issues

1. **Services can't connect to OpenTelemetry Collector**
   - Verify collector is running: `docker ps | grep otel-collector`
   - Check collector logs: `docker logs otel-collector`
   - Ensure services use correct endpoint in appsettings.json

2. **Missing traces or metrics in Grafana**
   - Check data source configurations in Grafana
   - Verify collector is receiving data: `curl http://localhost:8888/metrics`
   - Check Prometheus targets: http://localhost:9090/targets

3. **Docker networking issues**
   - If using Docker Desktop, ensure resources are sufficient
   - Try restarting the Docker daemon
   - Verify all containers are on the same network

## Contributing

Contributions are welcome! Please read our [Contributing Guidelines](./CONTRIBUTING.md) for details.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
